<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RALPH CMS Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Inter:wght@400;500;600&display=swap');
        
        :root {
            --ralph-pink: #EB008B;
            --ralph-pink-light: #ff1493;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-light: #f5f5f5;
            --text-gray: #b0b0b0;
            --border-color: #404040;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            line-height: 1.6;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #2d1b69 100%);
        }

        .login-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-family: 'VT323', monospace;
            font-size: 32px;
            color: var(--ralph-pink);
            margin-bottom: 8px;
            text-shadow: 0 0 10px rgba(235, 0, 139, 0.3);
        }

        .login-header p {
            color: var(--text-gray);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--dark-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--ralph-pink);
            box-shadow: 0 0 0 3px rgba(235, 0, 139, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--ralph-pink) 0%, var(--ralph-pink-light) 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(235, 0, 139, 0.3);
        }

        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--dark-bg);
        }

        .admin-header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-family: 'VT323', monospace;
            font-size: 24px;
            color: var(--ralph-pink);
        }

        .admin-nav {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .nav-btn {
            padding: 8px 16px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--ralph-pink);
            border-color: var(--ralph-pink);
        }

        .admin-content {
            display: flex;
            height: calc(100vh - 73px);
        }

        .admin-sidebar {
            width: 280px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 24px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 32px;
        }

        .sidebar-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .sidebar-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background: var(--ralph-pink);
        }

        .sidebar-item .icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Expandable modules section */
        .sidebar-modules {
            margin-top: 10px;
        }

        .sidebar-modules-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            cursor: pointer;
            background: #2d2d2d;
            border-radius: 6px;
            margin-bottom: 8px;
            user-select: none;
            transition: background 0.2s ease;
        }

        .sidebar-modules-header:hover {
            background: #3d3d3d;
        }

        .expand-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .sidebar-modules-header.expanded .expand-arrow {
            transform: rotate(90deg);
        }

        .modules-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .modules-submenu.expanded {
            max-height: 600px;
            overflow-y: auto;
        }

        .module-submenu-item {
            padding: 8px 12px 8px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            border-left: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .module-submenu-item:hover {
            background: #2d2d2d;
            border-left-color: var(--ralph-pink);
        }

        .module-submenu-item.active {
            background: #3d3d3d;
            border-left-color: var(--ralph-pink);
            color: var(--ralph-pink);
        }

        .module-icon {
            font-size: 14px;
        }

        .main-panel {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .panel-section {
            display: none;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .panel-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .section-header p {
            color: var(--text-gray);
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-field {
            margin-bottom: 16px;
        }

        .form-field label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-light);
            font-size: 14px;
        }

        .form-field input, 
        .form-field textarea, 
        .form-field select {
            width: 100%;
            padding: 10px 12px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-field textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-field input:focus, 
        .form-field textarea:focus, 
        .form-field select:focus {
            outline: none;
            border-color: var(--ralph-pink);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--ralph-pink);
            color: white;
            position: relative;
        }

        .btn-primary:hover {
            background: var(--ralph-pink-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(235, 0, 139, 0.3);
        }
        
        .btn-primary:active {
            background: #10b981;
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
        }
        
        .btn-primary.success-flash {
            background: #10b981 !important;
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% { 
                background: #10b981;
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .btn-secondary {
            background: var(--dark-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .action-bar {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .module-status {
            margin-left: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateY(-5px);
        }
        
        .module-status.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .module-status.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .module-status.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .module-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .module-card {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .module-card h4 {
            margin-bottom: 8px;
            color: var(--ralph-pink);
        }

        .module-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--ralph-pink);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .json-editor {
            background: #1e1e1e;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            color: #d4d4d4;
            resize: vertical;
            min-height: 300px;
            white-space: pre;
            overflow: auto;
        }

        /* Drag and Drop Styles */
        .draggable-item {
            cursor: move;
            transition: all 0.2s ease;
        }

        .draggable-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .draggable-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drag-over {
            border-top: 2px solid var(--ralph-pink) !important;
        }

        .drag-handle {
            cursor: move;
            color: var(--text-gray);
            margin-right: 8px;
            font-size: 14px;
        }

        .drag-handle:hover {
            color: var(--ralph-pink);
        }

        @media (max-width: 768px) {
            .admin-content {
                flex-direction: column;
                height: auto;
            }
            
            .admin-sidebar {
                width: 100%;
                order: 2;
            }
            
            .main-panel {
                order: 1;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <h1>RALPH CMS</h1>
                <p>Content Management System</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">Sign In</button>
            </form>
            <div id="loginError" class="alert alert-error" style="display: none; margin-top: 16px;">
                Invalid credentials. Please try again.
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-container" id="adminContainer">
        <div class="admin-header">
            <h1>üìä RALPH CMS Admin</h1>
            <div class="admin-nav">
                <button class="nav-btn" onclick="saveChanges()">üíæ Save Changes</button>
                <button class="nav-btn" onclick="previewSite()">üëÅÔ∏è Preview</button>
                <button class="nav-btn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>

        <div class="admin-content">
            <div class="admin-sidebar">
                <div class="sidebar-section">
                    <h3>Content Management</h3>
                    
                    <!-- Expandable Modules Section -->
                    <div class="sidebar-modules">
                        <div class="sidebar-modules-header expanded" onclick="toggleModulesMenu()">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="icon">üîß</span>
                                <span>MODULES</span>
                            </div>
                            <span class="expand-arrow">‚ñ∂</span>
                        </div>
                        <div class="modules-submenu expanded" id="modulesSubmenu">
                            <div class="module-submenu-item" onclick="loadSpecificModule('newBiz')">
                                <span class="module-icon">üìä</span>
                                <span>New Business Pipeline</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('premieres')">
                                <span class="module-icon">üé¨</span>
                                <span>Premiere Calendar</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('pitchPlease')">
                                <span class="module-icon">üí°</span>
                                <span>Pitch, Please!</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('shoutouts')">
                                <span class="module-icon">üéâ</span>
                                <span>Shoutouts & Celebrations</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('articles')">
                                <span class="module-icon">üì∞</span>
                                <span>Industry Articles</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('ralphNews')">
                                <span class="module-icon">üì¢</span>
                                <span>RALPH News</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('suggestions')">
                                <span class="module-icon">üí≠</span>
                                <span>Suggestion Box</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('announcements')">
                                <span class="module-icon">üì£</span>
                                <span>Announcements</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('links')">
                                <span class="module-icon">üîó</span>
                                <span>Quick Links</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('innovation')">
                                <span class="module-icon">üí°</span>
                                <span>Innovation Updates</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('resources')">
                                <span class="module-icon">üìÅ</span>
                                <span>Resources</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('sharing')">
                                <span class="module-icon">üì≤</span>
                                <span>Weekly Share Challenge</span>
                            </div>
                            <div class="module-submenu-item" onclick="loadSpecificModule('music')">
                                <span class="module-icon">üéµ</span>
                                <span>Music Library</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-item" onclick="showPanel('chatbot')">
                        <span class="icon">ü§ñ</span>
                        <span>Chatbot</span>
                    </div>
                    <div class="sidebar-item" onclick="showPanel('system')">
                        <span class="icon">‚öôÔ∏è</span>
                        <span>System Settings</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>Advanced</h3>
                    <div class="sidebar-item" onclick="showPanel('api')">
                        <span class="icon">üîå</span>
                        <span>API Config</span>
                    </div>
                    <div class="sidebar-item" onclick="showPanel('raw')">
                        <span class="icon">üìù</span>
                        <span>Raw Editor</span>
                    </div>
                </div>
            </div>

            <div class="main-panel">
                <!-- Modules Panel -->
                <div id="modules" class="panel-section active">
                    <div class="section-header">
                        <h2 id="moduleTitleHeader">Module Editor</h2>
                        <p id="moduleDescription">Select a module from the sidebar to edit its content</p>
                    </div>

                    <div id="moduleEditor">
                        <!-- Module-specific forms will be loaded here -->
                        <div style="padding: 40px; text-align: center; color: #888;">
                            <p style="font-size: 16px;">üëà Select a module from the sidebar to begin editing</p>
                            <p style="font-size: 14px; margin-top: 10px;">All modules are listed under the MODULES section</p>
                        </div>
                    </div>
                </div>

                <!-- Chatbot Panel -->
                <div id="chatbot" class="panel-section">
                    <div class="section-header">
                        <h2>Chatbot Configuration</h2>
                        <p>Configure your AI assistant settings</p>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label>Assistant Name</label>
                            <input type="text" id="chatbotTitle" value="RALPH Assistant v1.0">
                        </div>
                        <div class="form-field">
                            <label>OpenAI Model</label>
                            <select id="openaiModel">
                                <option value="gpt-4">GPT-4 (Recommended)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-field">
                        <label>OpenAI API Key</label>
                        <div style="padding: 8px; background: #e8f5e8; border: 1px solid #4CAF50; border-radius: 4px; color: #2e7d32; font-size: 14px;">
                            üîí API key is now managed securely via Railway environment variables.<br>
                            Set <code>OPENAI_API_KEY</code> in your Railway dashboard.
                        </div>
                    </div>

                    <div class="form-field">
                        <label>Welcome Message <span style="color: #666; font-size: 12px;">(Initial greeting when chatbot opens)</span></label>
                        <input type="text" id="welcomeMessage" value="Welcome to RALPH's Super-Intranet!" style="width: 100%; padding: 8px; font-size: 14px;">
                    </div>
                    
                    <div class="form-field">
                        <label>Help Text <span style="color: #666; font-size: 12px;">("Here's what you can do:" section)</span></label>
                        <textarea id="helpText" style="min-height: 150px; font-family: 'Courier New', monospace; font-size: 13px;">Here's what you can do:
‚ñ∫ Click any desktop icon to open modules
‚ñ∫ Drag windows by their title bars
‚ñ∫ Minimize, maximize, or close windows
‚ñ∫ Submit suggestions in the Suggestion Box
‚ñ∫ Submit pitches to quarterly competition
‚ñ∫ Check project pipelines and deadlines
‚ñ∫ Send shoutouts to team members</textarea>
                        <div style="margin-top: 8px;">
                            <button type="button" id="updateWelcomeBtn" onclick="updateChatbotContent()" class="btn btn-primary">üíæ Update Chatbot Content</button>
                            <div class="module-status" id="status-chatbot-content" style="display: inline-block; margin-left: 10px;"></div>
                        </div>
                    </div>

                    <div class="form-field" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <label>System Prompt <span style="color: #666; font-size: 12px;">(Defines AI personality and knowledge base)</span></label>
                        <div id="promptLastUpdated" style="margin-bottom: 8px; padding: 6px 10px; background: #2196F3; color: white; border-radius: 4px; font-size: 12px;">
                            ‚ÑπÔ∏è Loading prompt info...
                        </div>
                        <textarea id="systemPrompt" rows="15" placeholder="Enter your custom system prompt..." style="font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="promptAuthor" placeholder="Your name" style="width: 120px; padding: 4px; font-size: 12px;">
                            <input type="text" id="promptComment" placeholder="Brief description of changes (optional)" style="flex: 1; padding: 4px; font-size: 12px;">
                            <button type="button" onclick="savePrompt()" style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Save Prompt</button>
                            <button type="button" onclick="showPromptHistory()" style="background: #2196F3; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">History</button>
                        </div>
                        <div id="promptStatus" style="margin-top: 4px; font-size: 12px; color: #666;"></div>
                    </div>
                </div>

                <!-- System Settings Panel -->
                <div id="system" class="panel-section">
                    <div class="section-header">
                        <h2>System Settings</h2>
                        <p>Configure global system preferences</p>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label>Company Name</label>
                            <input type="text" id="companyName" value="RALPH">
                        </div>
                        <div class="form-field">
                            <label>Primary Color</label>
                            <input type="color" id="primaryColor" value="#EB008B">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label>Ralph.World URL</label>
                            <input type="url" id="ralphWorldUrl" value="https://ralph.world" placeholder="https://ralph.world">
                        </div>
                    </div>

                    <div class="form-field">
                        <label>Boot Messages <span style="color: #666; font-size: 12px;">(One per line - displays during boot sequence)</span></label>
                        <textarea id="bootMessages" rows="8" style="min-height: 200px;">Loading system kernel...
Initializing RALPH protocols...
Checking security clearance...
Loading user preferences...
Mounting network drives...
Starting creative services...
Loading project database...
System ready!</textarea>
                        <div style="margin-top: 8px;">
                            <button type="button" id="updateBootBtn" onclick="updateBootMessages()" class="btn btn-primary">üíæ Update Boot Messages</button>
                            <div class="module-status" id="status-boot" style="display: inline-block; margin-left: 10px;"></div>
                        </div>
                    </div>
                </div>

                <!-- API Configuration Panel -->
                <div id="api" class="panel-section">
                    <div class="section-header">
                        <h2>API Configuration</h2>
                        <p>Connect external data sources and APIs</p>
                    </div>

                    <div class="form-row">
                        <div class="form-field">
                            <label>Base API URL</label>
                            <input type="url" id="apiBaseUrl" placeholder="https://api.yourcompany.com">
                        </div>
                        <div class="form-field">
                            <label>Refresh Interval (ms)</label>
                            <input type="number" id="refreshInterval" value="60000">
                        </div>
                    </div>

                    <div class="form-field">
                        <label>API Headers (JSON format)</label>
                        <textarea id="apiHeaders" rows="4">{
  "Content-Type": "application/json",
  "Authorization": "Bearer your-token-here"
}</textarea>
                    </div>
                </div>

                <!-- Raw Editor Panel -->
                <div id="raw" class="panel-section">
                    <div class="section-header">
                        <h2>Raw Configuration Editor</h2>
                        <p>Advanced users: Edit the raw CMS configuration JSON</p>
                    </div>

                    <textarea id="rawEditor" class="json-editor"></textarea>
                    
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="updateFromRaw()">üìù Update from JSON</button>
                        <button class="btn btn-secondary" onclick="formatJSON()">üé® Format JSON</button>
                        <button class="btn btn-secondary" onclick="resetToDefault()">üîÑ Reset to Default</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inline CMS Config as fallback
        const CMS_CONFIG = {
            system: {
                version: "1.0",
                companyName: "RALPH",
                primaryColor: "#EB008B",
                bootMessages: [
                    'Loading system kernel...',
                    'Initializing RALPH protocols...',
                    'Checking security clearance...',
                    'Loading user preferences...',
                    'Mounting network drives...',
                    'Starting creative services...',
                    'Loading project database...',
                    'Initializing communication modules...',
                    'Checking for updates...',
                    'Loading desktop environment...',
                    'Starting RALPH SUPER-INTRANET...',
                    'System ready!'
                ]
            },
            chatbot: {
                enabled: true,
                title: "RALPH Assistant v1.0",
                welcomeMessage: "Welcome to RALPH Super-Intranet!",
                helpText: `Here's what you can do:\n‚ñ∫ Click any desktop icon to open modules\n‚ñ∫ Drag windows by their title bars\n‚ñ∫ Minimize, maximize, or close windows\n‚ñ∫ Submit suggestions in the Suggestion Box\n‚ñ∫ Submit pitches to quarterly competition\n‚ñ∫ Check project pipelines and deadlines\n‚ñ∫ Send shoutouts to team members`,
                openai: {
                    enabled: false,
                    apiKey: "",
                    model: "gpt-4",
                    temperature: 0.7,
                    maxTokens: 150,
                    systemPrompt: `You are the RALPH company assistant. You help employees with:\n- Company policies and procedures\n- Project information and deadlines\n- Technical support\n- Creative inspiration\n- Team collaboration\nAlways maintain a friendly, professional tone and embody RALPH's creative spirit.`,
                    fallbackResponses: [
                        'Processing request...',
                        "That's interesting! Tell me more.",
                        'System acknowledged.',
                        'Roger that!',
                        'Command received.',
                        'Affirmative!'
                    ]
                }
            },
            modules: {
                newBiz: {
                    title: "New Business Pipeline v2.0",
                    icon: "üìä",
                    enabled: true,
                    content: {
                        header: "RALPH PIPELINE TRACKER 1.0",
                        warmLeads: [
                            { name: "Tech Startup - Brand Identity", dueDate: "2024-12-30", office: "NY", deckLink: "", briefLink: "" }
                        ],
                        pitchesHappening: [
                            { name: "Global Tech Corp - Video Campaign", dueDate: "2024-12-20", office: "LON", deckLink: "", briefLink: "" },
                            { name: "Fashion Brand X - Social Strategy", dueDate: "2024-12-22", office: "LA", deckLink: "", briefLink: "" }
                        ],
                        pitchSubmitted: [
                            { name: "Auto Company Z - Launch Film", dueDate: "2024-12-25", office: "NY", deckLink: "", briefLink: "" }
                        ],
                        pitchPresented: [
                            { name: "Beauty Brand Presentation", dueDate: "2024-12-18", office: "LA", deckLink: "", briefLink: "" }
                        ],
                        pitchWon: [
                            { name: "Entertainment Client RFP", dueDate: "2024-12-15", office: "TK", deckLink: "", briefLink: "" }
                        ]
                    },
                    apiEndpoint: null
                },
                premieres: {
                    title: "Project Premiere Calendar",
                    icon: "üé¨",
                    enabled: true,
                    content: {
                        thisMonth: [
                            { date: "Dec 15", project: "Urban Dreams Documentary", liveLink: "" },
                            { date: "Dec 20", project: "Holiday Campaign Launch", liveLink: "" },
                            { date: "Dec 28", project: "Year-End Showcase", liveLink: "" }
                        ],
                        nextMonth: [
                            { date: "Jan 10", project: "New Product Launch Film", liveLink: "" },
                            { date: "Jan 15", project: "Brand Refresh Campaign", liveLink: "" },
                            { date: "Jan 25", project: "Super Bowl Teaser", liveLink: "" }
                        ]
                    },
                    apiEndpoint: null
                },
                pitchPlease: {
                    title: "Pitch, Please!",
                    icon: "üí°",
                    enabled: true,
                    content: {
                        subtitle: "A quarterly competition where you can pitch almost anything you think is a winner",
                        currentQuarter: "Q1 2025",
                        deadline: "March 31, 2025",
                        theme: "Innovation & Growth",
                        prize: "Up to $50K",
                        currentSubmissions: 12,
                        daysLeft: 45
                    },
                    apiEndpoint: null
                },
                shoutouts: {
                    title: "Shoutouts & Celebrations",
                    icon: "üéâ",
                    enabled: true,
                    content: {
                        birthdays: [
                            { date: "Today", person: "Mike R. from Production", highlight: true },
                            { date: "Dec 18", person: "Jennifer L. from Creative" },
                            { date: "Dec 22", person: "Alex T. from Strategy" }
                        ],
                        anniversaries: [
                            { years: 5, person: "David K." },
                            { years: 3, person: "Lisa M." },
                            { years: 1, person: "Team Expansion Crew!" }
                        ],
                        shoutouts: [
                            { message: "Huge thanks to the edit team for crushing it on the Tech Corp project!", from: "Management" },
                            { message: "Props to IT for the smooth system upgrade!", from: "Everyone" }
                        ]
                    },
                    apiEndpoint: null
                },
                articles: {
                    title: "Industry Articles",
                    icon: "üì∞",
                    enabled: true,
                    content: {
                        trending: [
                            "The Rise of AI in Creative Production",
                            "2025 Design Trends to Watch",
                            "Sustainable Filmmaking Practices"
                        ],
                        mustReads: [
                            { source: "AdWeek", title: "Agencies of the Future" },
                            { source: "Campaign", title: "Digital First Strategies" },
                            { source: "Creative Review", title: "Best Campaigns 2024" }
                        ]
                    },
                    apiEndpoint: null
                },
                ralphNews: {
                    title: "RALPH News Network",
                    icon: "üì¢",
                    enabled: true,
                    content: {
                        breaking: [
                            { headline: "New Office Space Opening Q1 2025!", live: true },
                            { headline: "Award Win: Best Campaign at Industry Awards", live: false },
                            { headline: "Client Win: Major Automotive Account", live: false }
                        ],
                        updates: [
                            "New Equipment in Studio B",
                            "Holiday Party December 20th",
                            "Q4 Numbers Looking Strong!"
                        ]
                    },
                    apiEndpoint: null
                },
                suggestions: {
                    title: "Digital Suggestion Box",
                    icon: "üí≠",
                    enabled: true,
                    content: {
                        recentSuggestions: [
                            { idea: "Coffee machine upgrade", status: "APPROVED" },
                            { idea: "Flexible Friday hours", status: "IN REVIEW" },
                            { idea: "Pet-friendly office days", status: "CONSIDERING" }
                        ]
                    },
                    apiEndpoint: null,
                    submitEndpoint: null
                },
                announcements: {
                    title: "System Announcements",
                    icon: "üì£",
                    enabled: true,
                    content: {
                        important: [
                            "System maintenance scheduled for Saturday 2:00 AM",
                            "Please save all work before Friday EOD"
                        ],
                        general: [
                            "Parking lot B closed for repairs this week",
                            "New health benefits info session Thursday",
                            "Kitchen renovation complete - enjoy!"
                        ]
                    },
                    apiEndpoint: null
                },
                links: {
                    title: "Quick Links Directory",
                    icon: "üîó",
                    enabled: true,
                    content: {
                        internal: [
                            { name: "TIMESHEET SYSTEM", url: "#" },
                            { name: "PROJECT TRACKER", url: "#" },
                            { name: "EXPENSE REPORTS", url: "#" },
                            { name: "IT HELPDESK", url: "#" }
                        ],
                        external: [
                            { name: "CLIENT PORTAL", url: "#" },
                            { name: "VENDOR DATABASE", url: "#" },
                            { name: "STOCK FOOTAGE", url: "#" }
                        ]
                    },
                    apiEndpoint: null
                },
                innovation: {
                    title: "Innovation Lab Updates",
                    icon: "üí°",
                    enabled: true,
                    content: {
                        experiments: [
                            { name: "VR Production Pipeline - Phase 2", progress: 60 },
                            { name: "AI-Assisted Editing Tools", progress: 40 },
                            { name: "Real-time Rendering System", progress: 80 }
                        ],
                        nextSession: {
                            topic: "Future of Motion Graphics",
                            speaker: "Guest from Pixar"
                        }
                    },
                    apiEndpoint: null
                },
                resources: {
                    title: "Resource Center",
                    icon: "üìÅ",
                    enabled: true,
                    content: {
                        documents: [
                            "Brand Guidelines v3.2",
                            "Employee Handbook 2024",
                            "Creative Best Practices",
                            "Client Onboarding Guide"
                        ],
                        templates: [
                            "Presentation Template",
                            "Project Brief Template",
                            "Invoice Template"
                        ],
                        training: [
                            "New Software Tutorials",
                            "Client Communication 101",
                            "Project Management Basics"
                        ]
                    },
                    apiEndpoint: null
                },
                music: {
                    title: "Music Library Manager",
                    icon: "üéµ",
                    enabled: true,
                    content: {
                        tracks: [
                            { 
                                id: 1, 
                                title: "Kawaii Kitsune", 
                                artist: "Kevin MacLeod", 
                                file: "music/kawaii-kitsune-kevin-macleod-main-version-7984-04-02.mp3",
                                duration: "4:02",
                                uploadDate: "2024-08-19"
                            },
                            { 
                                id: 2, 
                                title: "Mirthaflare", 
                                artist: "Ian Aisling", 
                                file: "music/mirthaflare-ian-aisling-main-version-22101-02-36.mp3",
                                duration: "2:36",
                                uploadDate: "2024-08-19"
                            }
                        ],
                        totalTracks: 2,
                        totalDuration: "6:38"
                    },
                    apiEndpoint: null
                },
                sharing: {
                    title: "Weekly Share Challenge",
                    icon: "üì≤",
                    enabled: true,
                    content: {
                        weekOf: "December 23, 2024",
                        giftCardAmount: "$25",
                        items: [
                            {
                                id: 1,
                                type: "Instagram Post",
                                platform: "Instagram",
                                title: "RALPH's Creative Process",
                                description: "Behind-the-scenes look at our latest campaign development",
                                thumbnail: "headshots/8bit_Ronda.png",
                                shareUrl: "https://instagram.com/ralphstudio"
                            },
                            {
                                id: 2,
                                type: "Substack Article",
                                platform: "Substack",
                                title: "Innovation in Creative Strategy",
                                description: "Deep dive into our approach to breakthrough creative solutions",
                                thumbnail: "headshots/8bit_Ronda.png",
                                shareUrl: "https://ralphstudio.substack.com"
                            },
                            {
                                id: 3,
                                type: "TikTok Video",
                                platform: "TikTok",
                                title: "Quick Creative Tips",
                                description: "30-second tips for better creative thinking",
                                thumbnail: "headshots/8bit_Ronda.png",
                                shareUrl: "https://tiktok.com/@ralphstudio"
                            }
                        ]
                    },
                    apiEndpoint: null
                }
            },
            api: {
                baseUrl: "",
                headers: {
                    'Content-Type': 'application/json'
                },
                refreshInterval: 60000,
                retryAttempts: 3,
                timeout: 5000
            }
        };
        
        // Make available globally
        window.CMS_CONFIG = CMS_CONFIG;
    </script>
    <script>
        // Admin Authentication
        const ADMIN_CREDENTIALS = {
            username: 'ralph',
            password: 'admin123' // Change this in production!
        };

        let currentConfig = {};
        let isLoggedIn = false;
        
        // DOM cache for better performance
        const DOMCache = {
            elements: {},
            get(id) {
                if (!this.elements[id]) {
                    this.elements[id] = document.getElementById(id);
                }
                return this.elements[id];
            },
            querySelector(selector) {
                if (!this.elements[selector]) {
                    this.elements[selector] = document.querySelector(selector);
                }
                return this.elements[selector];
            },
            clear() {
                this.elements = {};
            }
        };
        
        // Debounce utility for input handlers
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                login();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        });

        async function login() {
            isLoggedIn = true;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // Load config from server
            console.log('Login - loading config from server...');
            await loadCurrentConfig();
            
            // Config is loaded, modules panel will show the default message
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('adminContainer').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Panel navigation
        function showPanel(panelId) {
            // Hide all panels
            document.querySelectorAll('.panel-section').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active class from module submenu items
            document.querySelectorAll('.module-submenu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected panel
            document.getElementById(panelId).classList.add('active');
            
            // Add active class to clicked sidebar item
            if (event && event.target) {
                const sidebarItem = event.target.closest('.sidebar-item');
                if (sidebarItem) {
                    sidebarItem.classList.add('active');
                }
            }

            // Special handling for raw editor panel
            if (panelId === 'raw') {
                // Update raw editor with current config
                updateConfigFromFields();
                document.getElementById('rawEditor').value = JSON.stringify(currentConfig, null, 2);
            }
        }

        // Toggle modules submenu
        function toggleModulesMenu() {
            const header = document.querySelector('.sidebar-modules-header');
            const submenu = document.getElementById('modulesSubmenu');
            
            header.classList.toggle('expanded');
            submenu.classList.toggle('expanded');
        }

        // Load specific module from sidebar
        async function loadSpecificModule(moduleId) {
            // Show modules panel
            document.querySelectorAll('.panel-section').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById('modules').classList.add('active');
            
            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Remove active class from all module items and add to selected
            document.querySelectorAll('.module-submenu-item').forEach(item => {
                item.classList.remove('active');
            });
            if (event && event.target) {
                const moduleItem = event.target.closest('.module-submenu-item');
                if (moduleItem) {
                    moduleItem.classList.add('active');
                }
            }
            
            // Load the module editor
            await loadModuleEditorForModule(moduleId);
        }

        // Track file modification timestamp for conflict detection
        let configLastModified = null;
        
        // Load current configuration from server
        async function loadCurrentConfig() {
            console.log('loadCurrentConfig called - fetching from server...');
            
            try {
                const response = await fetch('/api/get-config');
                if (response.ok) {
                    const result = await response.json();
                    console.log('üîç Raw result from server:', result);
                    console.log('üîç result.config:', result.config);
                    console.log('üîç result.config.modules:', result.config?.modules);
                    console.log('üîç typeof result.config.modules:', typeof result.config?.modules);
                    
                    // Handle new API structure with timestamp
                    if (result.config) {
                        currentConfig = result.config;
                        configLastModified = result.lastModified;
                        console.log('Config loaded from server with timestamp:', new Date(configLastModified));
                    } else {
                        // Fallback for old API structure
                        currentConfig = result;
                        configLastModified = Date.now();
                    }
                    console.log('Config loaded from server successfully, modules:', Object.keys(currentConfig.modules || {}));
                    populateFields();
                    const rawEditor = document.getElementById('rawEditor');
                    if (rawEditor) {
                        rawEditor.value = JSON.stringify(currentConfig, null, 2);
                    }
                } else {
                    throw new Error('Failed to load config from server');
                }
            } catch (error) {
                console.error('Error loading config from server, falling back to CMS_CONFIG:', error);
                
                // Fallback to CMS_CONFIG if server request fails
                if (typeof CMS_CONFIG !== 'undefined') {
                    try {
                        currentConfig = JSON.parse(JSON.stringify(CMS_CONFIG));
                        console.log('Config loaded from fallback successfully, modules:', Object.keys(currentConfig.modules || {}));
                        populateFields();
                        const rawEditor = document.getElementById('rawEditor');
                        if (rawEditor) {
                            rawEditor.value = JSON.stringify(currentConfig, null, 2);
                        }
                    } catch (fallbackError) {
                        console.error('Error with fallback config:', fallbackError);
                        currentConfig = {};
                    }
                } else {
                    console.error('Neither server config nor CMS_CONFIG available');
                    currentConfig = {};
                }
            }
        }

        // Populate form fields with current config
        function populateFields() {
            // System settings
            if (currentConfig.system) {
                const companyName = document.getElementById('companyName');
                const primaryColor = document.getElementById('primaryColor');
                const bootMessages = document.getElementById('bootMessages');
                
                if (companyName) companyName.value = currentConfig.system.companyName || '';
                if (primaryColor) primaryColor.value = currentConfig.system.primaryColor || '#EB008B';
                if (bootMessages) bootMessages.value = currentConfig.system.bootMessages?.join('\n') || '';
                
                const ralphWorldUrl = document.getElementById('ralphWorldUrl');
                if (ralphWorldUrl) ralphWorldUrl.value = currentConfig.system.ralphWorldUrl || 'https://ralph.world';
            }

            // Chatbot settings
            if (currentConfig.chatbot) {
                const chatbotTitle = document.getElementById('chatbotTitle');
                const welcomeMessage = document.getElementById('welcomeMessage');
                const helpText = document.getElementById('helpText');
                const openaiModel = document.getElementById('openaiModel');
                
                if (chatbotTitle) chatbotTitle.value = currentConfig.chatbot.title || '';
                if (welcomeMessage) welcomeMessage.value = currentConfig.chatbot.welcomeMessage || '';
                if (helpText) helpText.value = currentConfig.chatbot.helpText || '';
                
                if (currentConfig.chatbot.openai && openaiModel) {
                    openaiModel.value = currentConfig.chatbot.openai.model || 'gpt-4';
                    // Note: chatbotToggle was removed with the dashboard
                }
            }

            // API settings
            if (currentConfig.api) {
                const apiBaseUrl = document.getElementById('apiBaseUrl');
                const refreshInterval = document.getElementById('refreshInterval');
                const apiHeaders = document.getElementById('apiHeaders');
                
                if (apiBaseUrl) apiBaseUrl.value = currentConfig.api.baseUrl || '';
                if (refreshInterval) refreshInterval.value = currentConfig.api.refreshInterval || 60000;
                if (apiHeaders) apiHeaders.value = JSON.stringify(currentConfig.api.headers || {}, null, 2);
            }
        }

        // WYSIWYG Module Editor - for backward compatibility
        async function loadModuleEditor() {
            console.log('loadModuleEditor called for initialization');
        }

        // Load module editor for a specific module
        async function loadModuleEditorForModule(moduleId) {
            console.log('loadModuleEditorForModule called for:', moduleId);
            console.log('currentConfig:', currentConfig);
            console.log('currentConfig.modules exists:', !!(currentConfig && currentConfig.modules));
            
            // Ensure config is loaded from server
            if (!currentConfig || !currentConfig.modules) {
                console.log('Config not loaded, loading from server now...');
                await loadCurrentConfig();
                
                // Double-check after loading
                console.log('After loadCurrentConfig - currentConfig:', currentConfig);
                console.log('After loadCurrentConfig - has modules:', !!(currentConfig && currentConfig.modules));
                
                if (!currentConfig || !currentConfig.modules) {
                    console.error('Failed to load config from server');
                    const moduleEditor = document.getElementById('moduleEditor');
                    if (moduleEditor) {
                        moduleEditor.innerHTML = '<p style="color: red;">Failed to load configuration from server. Please refresh the page and try again.</p>';
                    }
                    return;
                }
            }
            
            console.log('Loading module:', moduleId);
            
            if (!moduleId) {
                document.getElementById('moduleEditor').innerHTML = '<p>Please select a module to edit.</p>';
                return;
            }

            const module = currentConfig.modules?.[moduleId];
            
            if (!module) {
                console.log('Module not found:', moduleId, 'Available modules:', Object.keys(currentConfig.modules || {}));
                document.getElementById('moduleEditor').innerHTML = `<p>Module "${moduleId}" not found. Available modules: ${Object.keys(currentConfig.modules || {}).join(', ')}</p>`;
                return;
            }

            console.log('Loading editor for module:', module.title);
            
            // Update the header to show current module
            const moduleTitleEl = document.getElementById('moduleTitleHeader');
            const moduleDescEl = document.getElementById('moduleDescription');
            if (moduleTitleEl) {
                moduleTitleEl.textContent = `${module.icon} ${module.title}`;
            }
            if (moduleDescEl) {
                moduleDescEl.textContent = 'Configure module settings and content';
            }

            let editorHtml = `
                <div class="form-row">
                    <div class="form-field">
                        <label>Module Title</label>
                        <input type="text" id="moduleTitle" value="${module.title || ''}">
                    </div>
                    <div class="form-field">
                        <label>Module Icon</label>
                        <input type="text" id="moduleIcon" value="${module.icon}">
                    </div>
                </div>

                <div class="form-field">
                    <label>Module Description</label>
                    <textarea id="moduleDescription" rows="3" placeholder="Brief description of what this module contains...">${module.description || ''}</textarea>
                </div>

                <div class="form-field">
                    <label>API Endpoint (optional)</label>
                    <input type="url" id="moduleApiEndpoint" value="${module.apiEndpoint || ''}" 
                           placeholder="https://api.yourcompany.com/${moduleId}">
                </div>

                <div class="module-toggle">
                    <label class="switch">
                        <input type="checkbox" id="moduleEnabled" ${module.enabled ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                    <span>Module Enabled</span>
                </div>
            `;

            // Add module-specific WYSIWYG editors
            editorHtml += getModuleSpecificEditor(moduleId, module.content);

            editorHtml += `
                <div class="action-bar">
                    <button class="btn btn-primary" id="updateBtn-${moduleId}" onclick="updateModule('${moduleId}')">üíæ Update Module</button>
                    <button class="btn btn-secondary" onclick="resetModule('${moduleId}')">üîÑ Reset to Default</button>
                    <div class="module-status" id="status-${moduleId}"></div>
                </div>
            `;

            document.getElementById('moduleEditor').innerHTML = editorHtml;
            
            // Initialize drag and drop for the loaded editor
            setTimeout(() => {
                initializeDragAndDrop();
            }, 100);
        }

        // Get module-specific WYSIWYG editor
        function getModuleSpecificEditor(moduleId, content) {
            switch (moduleId) {
                case 'newBiz':
                    return getNewBizEditor(content);
                case 'premieres':
                    return getPremieresEditor(content);
                case 'shoutouts':
                    return getShoutoutsEditor(content);
                case 'pitchPlease':
                    return getPitchPleaseEditor(content);
                case 'articles':
                    return getArticlesEditor(content);
                case 'ralphNews':
                    return getRalphNewsEditor(content);
                case 'announcements':
                    return getAnnouncementsEditor(content);
                case 'links':
                    return getLinksEditor(content);
                case 'innovation':
                    return getInnovationEditor(content);
                case 'resources':
                    return getResourcesEditor(content);
                case 'sharing':
                    return getSharingEditor(content);
                case 'music':
                    return getMusicEditor(content);
                case 'suggestions':
                    return getSuggestionsEditor(content);
                default:
                    return getGenericEditor(content);
            }
        }

        // New Business Pipeline Editor - Kanban Style
        function getNewBizEditor(content) {
            const stages = {
                warmLeads: content.warmLeads || [],
                pitchesHappening: content.pitchesHappening || [],
                pitchSubmitted: content.pitchSubmitted || [],
                pitchPresented: content.pitchPresented || [],
                pitchWon: content.pitchWon || []
            };
            const stageLabels = {
                warmLeads: 'WARM LEADS',
                pitchesHappening: 'PITCHES HAPPENING', 
                pitchSubmitted: 'PITCH SUBMITTED',
                pitchPresented: 'PITCH PRESENTED',
                pitchWon: 'PITCH WON'
            };

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üìä New Business Pipeline - Kanban View</h4>
                    <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 20px;">Manage your pipeline across all stages from warm leads to won pitches</p>
                    
                    ${Object.keys(stages).map(stageKey => `
                        <div style="margin-bottom: 24px;">
                            <h5 style="color: var(--ralph-pink); margin-bottom: 12px;">${stageLabels[stageKey]} (${stages[stageKey].length})</h5>
                            <div id="${stageKey}Items" style="border: 2px dashed #404040; padding: 12px; border-radius: 6px; min-height: 100px;">
                                ${stages[stageKey].map((item, index) => `
                                    <div class="pipeline-item-editor" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid var(--ralph-pink);">
                                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                                            <button onclick="removePipelineItem('${stageKey}', ${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">‚úï</button>
                                            <input type="text" value="${item.name || ''}" placeholder="Client/Project Name" style="flex: 2; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                                            <select style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                                                <option value="LON" ${item.office === 'LON' ? 'selected' : ''}>LON</option>
                                                <option value="NY" ${item.office === 'NY' ? 'selected' : ''}>NY</option>
                                                <option value="LA" ${item.office === 'LA' ? 'selected' : ''}>LA</option>
                                                <option value="TK" ${item.office === 'TK' ? 'selected' : ''}>TK</option>
                                            </select>
                                            <input type="date" value="${item.dueDate || ''}" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                                        </div>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                            <input type="url" value="${item.deckLink || ''}" placeholder="Google Drive Deck Link" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 11px;">
                                            <input type="url" value="${item.briefLink || ''}" placeholder="Google Drive Brief Link" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 11px;">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="addPipelineItem('${stageKey}')" class="btn btn-secondary" style="margin-top: 8px; font-size: 12px;">+ Add to ${stageLabels[stageKey]}</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Premieres Calendar Editor
        function getPremieresEditor(content) {
            const thisMonth = content.thisMonth || [];
            const nextMonth = content.nextMonth || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üìÖ This Month</h4>
                    <div id="thisMonth">
                        ${thisMonth.map((item, index) => `
                            <div class="premiere-item draggable-item" draggable="true" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                                    <button onclick="removeThisMonth(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${item.date}" placeholder="Date" style="width: 100px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <input type="text" value="${item.project}" placeholder="Project name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <div style="margin-left: 44px;">
                                    <input type="url" value="${item.liveLink || ''}" placeholder="Live Link (Optional)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addThisMonth()" class="btn btn-secondary" style="margin-top: 8px;">+ Add This Month</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üìÖ Next Month</h4>
                    <div id="nextMonth">
                        ${nextMonth.map((item, index) => `
                            <div class="premiere-item draggable-item" draggable="true" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                                    <button onclick="removeNextMonth(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${item.date}" placeholder="Date" style="width: 100px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <input type="text" value="${item.project}" placeholder="Project name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <div style="margin-left: 44px;">
                                    <input type="url" value="${item.liveLink || ''}" placeholder="Live Link (Optional)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addNextMonth()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Next Month</button>
                </div>
            `;
        }

        // Shoutouts Editor
        function getShoutoutsEditor(content) {
            const birthdays = content.birthdays || [];
            const anniversaries = content.anniversaries || [];
            const shoutouts = content.shoutouts || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üéÇ Birthdays</h4>
                    <div id="birthdays">
                        ${birthdays.map((item, index) => `
                            <div class="birthday-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeBirthday(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${item.date}" placeholder="Date" style="width: 100px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <input type="text" value="${item.person}" placeholder="Person name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <label style="display: flex; align-items: center; gap: 8px; color: #b0b0b0;">
                                    <input type="checkbox" ${item.highlight ? 'checked' : ''}>
                                    Highlight
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addBirthday()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Birthday</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üéä Work Anniversaries</h4>
                    <div id="anniversaries">
                        ${anniversaries.map((item, index) => `
                            <div class="anniversary-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeAnniversary(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="number" value="${item.years}" placeholder="Years" style="width: 80px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <span style="color: #b0b0b0;">years</span>
                                <input type="text" value="${item.person}" placeholder="Person name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addAnniversary()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Anniversary</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üì¢ Shoutouts</h4>
                    <div id="shoutouts">
                        ${shoutouts.map((item, index) => `
                            <div class="shoutout-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: flex-start; margin-bottom: 8px;">
                                    <button onclick="removeShoutout(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <textarea placeholder="Shoutout message" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 60px; resize: vertical;">${item.message}</textarea>
                                </div>
                                <input type="text" value="${item.from}" placeholder="From (person/department)" style="width: 200px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addShoutout()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Shoutout</button>
                </div>
            `;
        }

        // Generic fallback editor for other modules
        function getGenericEditor(content) {
            return `
                <div class="form-field">
                    <label>Module Content (JSON)</label>
                    <textarea id="moduleContent" class="json-editor" rows="15">${JSON.stringify(content || {}, null, 2)}</textarea>
                    <small style="color: #b0b0b0; margin-top: 4px; display: block;">Advanced: Edit raw JSON content</small>
                </div>
            `;
        }

        // Creative Challenge Editor
        function getChallengeEditor(content) {
            const creative = content.creative || {};
            const social = content.social || {};
            const newBusiness = content.newBusiness || {};

            function getChallengeSection(type, challenge, icon, defaultLabel) {
                return `
                    <div style="background: #2d2d2d; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <h5 style="color: var(--ralph-pink); margin: 0;">${icon}</h5>
                            <input type="text" id="${type}Label" value="${challenge.label || defaultLabel}" placeholder="Section Label" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: var(--ralph-pink); padding: 6px 10px; border-radius: 4px; font-weight: bold;">
                            <span style="color: #888;">Challenge</span>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Title</label>
                            <input type="text" id="${type}Title" value="${challenge.title || ''}" placeholder="Challenge Title" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Objective</label>
                            <textarea id="${type}Objective" placeholder="What's the goal of this challenge?" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 80px; resize: vertical;">${challenge.objective || ''}</textarea>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Tone & Style</label>
                            <textarea id="${type}Tone" placeholder="How should submissions feel? (use \\n for line breaks)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 80px; resize: vertical;">${challenge.tone || ''}</textarea>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Examples</label>
                            <textarea id="${type}Examples" placeholder="Provide specific examples (use \\n for line breaks)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 80px; resize: vertical;">${challenge.examples || ''}</textarea>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Deliverables</label>
                            <textarea id="${type}Deliverables" placeholder="What should people submit? (use \\n for line breaks)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 60px; resize: vertical;">${challenge.deliverables || ''}</textarea>
                        </div>
                        <div>
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Deadline</label>
                            <input type="text" id="${type}Deadline" value="${challenge.deadline || ''}" placeholder="When and where to submit" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                    </div>
                `;
            }

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üé® Blog-Style Challenge Editor</h4>
                    <p style="color: #b0b0b0; font-size: 12px; margin-bottom: 20px;">Manage three challenge types with detailed blog-style content</p>
                    
                    ${getChallengeSection('creative', creative, 'üé®', 'Creative')}
                    ${getChallengeSection('social', social, 'üì±', 'Social')}
                    ${getChallengeSection('newBusiness', newBusiness, 'üíº', 'New Business')}
                </div>
            `;
        }

        // Industry Articles Editor
        function getArticlesEditor(content) {
            const trending = content.trending || [];
            const mustReads = content.mustReads || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üìà Trending Articles</h4>
                    <div id="trendingArticles">
                        ${trending.map((article, index) => {
                            const title = typeof article === 'string' ? article : (article.title || '');
                            const url = typeof article === 'object' ? (article.url || '') : '';
                            return `
                            <div class="trending-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <button onclick="removeTrendingArticle(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${title}" placeholder="Article title" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <input type="url" value="${url}" placeholder="Article URL (optional - for iframe/new window)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `}).join('')}
                    </div>
                    <button onclick="addTrendingArticle()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Trending Article</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üìñ Must Reads</h4>
                    <div id="mustReads">
                        ${mustReads.map((item, index) => `
                            <div class="mustread-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <button onclick="removeMustRead(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${item.source || ''}" placeholder="Source" style="width: 120px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <input type="text" value="${item.title || ''}" placeholder="Article title" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <input type="url" value="${item.url || ''}" placeholder="Article URL (optional - for iframe/new window)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addMustRead()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Must Read</button>
                </div>
            `;
        }

        // Pitch Please Editor
        function getPitchPleaseEditor(content) {
            content = content || {};
            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üí° Pitch, Please! Settings</h4>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Subtitle</label>
                        <input type="text" id="pitchSubtitle" value="${content.subtitle || ''}" placeholder="Competition tagline" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Current Quarter</label>
                            <input type="text" id="currentQuarter" value="${content.currentQuarter || 'Q1 2025'}" placeholder="Q1 2025" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Deadline</label>
                            <input type="text" id="deadline" value="${content.deadline || ''}" placeholder="March 31, 2025" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Theme</label>
                        <input type="text" id="pitchTheme" value="${content.theme || ''}" placeholder="Innovation & Growth" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Prize</label>
                        <input type="text" id="pitchPrize" value="${content.prize || ''}" placeholder="Up to $50K" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Current Submissions</label>
                            <input type="number" id="currentSubmissions" value="${content.currentSubmissions || 0}" min="0" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Days Left</label>
                            <input type="number" id="daysLeft" value="${content.daysLeft || 0}" min="0" style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
        }
        
        // RALPH News Editor
        function getRalphNewsEditor(content) {
            const breaking = content.breaking || [];
            const updates = content.updates || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üî¥ Breaking News</h4>
                    <div id="breakingNews">
                        ${breaking.map((item, index) => `
                            <div class="breaking-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeBreakingNews(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${item.headline || ''}" placeholder="Headline" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <label style="display: flex; align-items: center; gap: 8px; color: #b0b0b0;">
                                    <input type="checkbox" ${item.live ? 'checked' : ''}>
                                    Live
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addBreakingNews()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Breaking News</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üì∞ General Updates</h4>
                    <div id="generalUpdates">
                        ${updates.map((update, index) => `
                            <div class="update-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeGeneralUpdate(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${update}" placeholder="Update text" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addGeneralUpdate()" class="btn btn-secondary" style="margin-top: 8px;">+ Add General Update</button>
                </div>
            `;
        }

        // System Announcements Editor
        function getAnnouncementsEditor(content) {
            const important = content.important || [];
            const general = content.general || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">‚ö†Ô∏è Important Announcements</h4>
                    <div id="importantAnnouncements">
                        ${important.map((announcement, index) => `
                            <div class="important-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeImportantAnnouncement(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${announcement}" placeholder="Important announcement" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addImportantAnnouncement()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Important Announcement</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üì¢ General Announcements</h4>
                    <div id="generalAnnouncements">
                        ${general.map((announcement, index) => `
                            <div class="general-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeGeneralAnnouncement(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${announcement}" placeholder="General announcement" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addGeneralAnnouncement()" class="btn btn-secondary" style="margin-top: 8px;">+ Add General Announcement</button>
                </div>
            `;
        }

        // Quick Links Editor
        function getLinksEditor(content) {
            const internal = content.internal || [];
            const external = content.external || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üè¢ Internal Links</h4>
                    <div id="internalLinks">
                        ${internal.map((link, index) => `
                            <div class="internal-link-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeInternalLink(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${link.name || ''}" placeholder="Link name" style="width: 200px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <input type="url" value="${link.url || ''}" placeholder="URL" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addInternalLink()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Internal Link</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üåê External Links</h4>
                    <div id="externalLinks">
                        ${external.map((link, index) => `
                            <div class="external-link-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                                <button onclick="removeExternalLink(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                <input type="text" value="${link.name || ''}" placeholder="Link name" style="width: 200px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <input type="url" value="${link.url || ''}" placeholder="URL" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addExternalLink()" class="btn btn-secondary" style="margin-top: 8px;">+ Add External Link</button>
                </div>
            `;
        }

        // Innovation Lab Editor
        function getInnovationEditor(content) {
            const experiments = content.experiments || [];
            const nextSession = content.nextSession || {};

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üß™ Current Experiments</h4>
                    <div id="experiments">
                        ${experiments.map((experiment, index) => `
                            <div class="experiment-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <button onclick="removeExperiment(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${experiment.name || ''}" placeholder="Experiment name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <input type="number" value="${experiment.progress || 0}" min="0" max="100" placeholder="Progress %" style="width: 80px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <span style="color: #b0b0b0;">%</span>
                                </div>
                                <input type="url" value="${experiment.url || ''}" placeholder="Experiment URL (optional - for iframe/new window)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addExperiment()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Experiment</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üìÖ Next Session</h4>
                    <div style="background: #2d2d2d; padding: 16px; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Topic</label>
                                <input type="text" id="nextSessionTopic" value="${nextSession.topic || ''}" placeholder="Future of Motion Graphics" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="color: #b0b0b0; margin-bottom: 4px; display: block;">Speaker</label>
                                <input type="text" id="nextSessionSpeaker" value="${nextSession.speaker || ''}" placeholder="Guest from Pixar" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Resources Center Editor
        function getResourcesEditor(content) {
            const documents = content.documents || [];
            const templates = content.templates || [];
            const training = content.training || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üìÑ Documents</h4>
                    <div id="documents">
                        ${documents.map((doc, index) => {
                            const name = typeof doc === 'string' ? doc : (doc.name || '');
                            const url = typeof doc === 'object' ? (doc.url || '') : '';
                            return `
                            <div class="document-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <button onclick="removeDocument(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${name}" placeholder="Document name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <input type="url" value="${url}" placeholder="Document URL (optional - opens in new window)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `}).join('')}
                    </div>
                    <button onclick="addDocument()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Document</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üìã Templates</h4>
                    <div id="templates">
                        ${templates.map((template, index) => {
                            const name = typeof template === 'string' ? template : (template.name || '');
                            const url = typeof template === 'object' ? (template.url || '') : '';
                            return `
                            <div class="template-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <button onclick="removeTemplate(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${name}" placeholder="Template name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <input type="url" value="${url}" placeholder="Template URL (optional - opens in new window)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `}).join('')}
                    </div>
                    <button onclick="addTemplate()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Template</button>

                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üéì Training</h4>
                    <div id="training">
                        ${training.map((course, index) => {
                            const name = typeof course === 'string' ? course : (course.name || '');
                            const url = typeof course === 'object' ? (course.url || '') : '';
                            return `
                            <div class="training-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <button onclick="removeTraining(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${name}" placeholder="Training course name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                </div>
                                <input type="url" value="${url}" placeholder="Training URL (optional - opens in new window)" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                            </div>
                        `}).join('')}
                    </div>
                    <button onclick="addTraining()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Training Course</button>
                </div>
            `;
        }

        // Suggestions Editor
        function getSuggestionsEditor(content) {
            const recentSuggestions = content.recentSuggestions || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üí° Recent Suggestions</h4>
                    <div id="recentSuggestions">
                        ${recentSuggestions.map((suggestion, index) => `
                            <div class="suggestion-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: flex; gap: 12px; align-items: flex-start; margin-bottom: 8px;">
                                    <button onclick="removeSuggestion(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <textarea placeholder="Suggestion idea" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 60px; resize: vertical;">${suggestion.idea || ''}</textarea>
                                </div>
                                <select style="width: 150px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                                    <option value="APPROVED" ${suggestion.status === 'APPROVED' ? 'selected' : ''}>APPROVED</option>
                                    <option value="IN REVIEW" ${suggestion.status === 'IN REVIEW' ? 'selected' : ''}>IN REVIEW</option>
                                    <option value="CONSIDERING" ${suggestion.status === 'CONSIDERING' ? 'selected' : ''}>CONSIDERING</option>
                                    <option value="ON HOLD" ${suggestion.status === 'ON HOLD' ? 'selected' : ''}>ON HOLD</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addSuggestion()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Suggestion</button>
                </div>
            `;
        }

        // Update module
        function updateModule(moduleId) {
            console.log('üîÑ UPDATE MODULE STARTED:', moduleId);
            console.log('üìã Current module config before update:', currentConfig.modules[moduleId]);
            
            const title = document.getElementById('moduleTitle').value;
            const icon = document.getElementById('moduleIcon').value;
            const description = document.getElementById('moduleDescription').value;
            const apiEndpoint = document.getElementById('moduleApiEndpoint').value;
            const enabled = document.getElementById('moduleEnabled').checked;
            
            console.log('üìù Form values collected:', { title, icon, description, apiEndpoint, enabled });
            
            let content = {};
            
            // Handle WYSIWYG data collection for specific modules
            if (moduleId === 'newBiz') {
                content = getNewBizWYSIWYGData();
            } else if (moduleId === 'premieres') {
                content = getPremieresWYSIWYGData();
            } else if (moduleId === 'shoutouts') {
                content = getShoutoutsWYSIWYGData();
            } else if (moduleId === 'challenge') {
                content = getChallengeWYSIWYGData();
            } else if (moduleId === 'articles') {
                content = getArticlesWYSIWYGData();
            } else if (moduleId === 'ralphNews') {
                content = getRalphNewsWYSIWYGData();
            } else if (moduleId === 'announcements') {
                content = getAnnouncementsWYSIWYGData();
            } else if (moduleId === 'links') {
                content = getLinksWYSIWYGData();
            } else if (moduleId === 'innovation') {
                content = getInnovationWYSIWYGData();
            } else if (moduleId === 'resources') {
                content = getResourcesWYSIWYGData();
            } else if (moduleId === 'music') {
                content = getMusicWYSIWYGData();
            } else if (moduleId === 'suggestions') {
                content = getSuggestionsWYSIWYGData();
            } else if (moduleId === 'sharing') {
                content = getSharingWYSIWYGData();
            } else {
                // Fallback to JSON editor for other modules
                try {
                    const jsonEditor = document.getElementById('moduleContent');
                    if (jsonEditor) {
                        content = JSON.parse(jsonEditor.value);
                    } else {
                        content = currentConfig.modules[moduleId].content; // Keep existing content
                    }
                } catch (e) {
                    alert('Invalid JSON in module content. Please check your syntax.');
                    return;
                }
            }

            const updatedModule = {
                ...currentConfig.modules[moduleId],
                title,
                icon,
                description,
                apiEndpoint: apiEndpoint || null,
                enabled,
                content
            };
            
            console.log('üì¶ Updated module data:', updatedModule);
            console.log('üîç Content changes:', JSON.stringify(content, null, 2));
            
            currentConfig.modules[moduleId] = updatedModule;
            
            console.log('üíæ Saving configuration to server...');
            // Show local status immediately
            showModuleStatus(moduleId, 'Saving...', 'success');
            
            // Save the updated configuration to server
            saveConfigToServer(moduleId);
        }

        // Save configuration to server
        async function saveConfigToServer(moduleId = null) {
            console.log('üåê SAVE CONFIG TO SERVER STARTED');
            console.log('üì§ Sending config with modules:', Object.keys(currentConfig.modules || {}));
            
            try {
                console.log('üîÑ Making POST request to /api/save-config...');
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        configData: currentConfig,
                        lastModified: configLastModified
                    })
                });

                console.log('üì° Response received, status:', response.status);
                const result = await response.json();
                console.log('üìã Server response:', result);
                
                if (result.success) {
                    console.log('‚úÖ Configuration saved successfully to server!');
                    // Update our timestamp after successful save
                    configLastModified = Date.now();
                    
                    // Show local module status if moduleId is provided
                    if (moduleId) {
                        showModuleStatus(moduleId, 'Updated successfully!', 'success');
                    } else {
                        showAlert('Configuration saved successfully! Frontend will update automatically.', 'success');
                    }
                    
                    // Update the raw editor to reflect the changes
                    const rawEditor = document.getElementById('rawEditor');
                    if (rawEditor) {
                        rawEditor.value = JSON.stringify(currentConfig, null, 2);
                    }
                    
                    // Log completion
                    console.log('üéâ UPDATE PROCESS COMPLETED - Changes should appear on frontend within 10 seconds');
                } else if (result.conflict) {
                    // Handle conflict detection
                    const conflictMessage = `‚ö†Ô∏è CONFLICT DETECTED\n\nThe configuration file has been modified by another user since you loaded it.\n\nYour timestamp: ${new Date(result.userModified)}\nFile timestamp: ${new Date(result.currentModified)}\n\nOptions:\n‚Ä¢ Click OK to reload the latest version (your changes will be lost)\n‚Ä¢ Click Cancel to force save anyway (will overwrite other user's changes)`;
                    
                    if (confirm(conflictMessage)) {
                        // User chose to reload - refresh the page to get latest config
                        console.log('üîÑ User chose to reload latest config');
                        location.reload();
                    } else {
                        // User chose to force save - save without timestamp check
                        console.log('‚ö†Ô∏è User chose to force save - removing timestamp check');
                        configLastModified = null; // Remove timestamp to bypass conflict check
                        await saveConfigToServer(moduleId); // Retry save
                    }
                } else {
                    console.error('‚ùå Server returned failure:', result.message);
                    if (moduleId) {
                        showModuleStatus(moduleId, 'Failed to save: ' + result.message, 'error');
                    } else {
                        showAlert('Failed to save configuration: ' + result.message, 'error');
                    }
                }
            } catch (error) {
                console.error('üí• Save config error:', error);
                if (moduleId) {
                    showModuleStatus(moduleId, 'Error saving: ' + error.message, 'error');
                } else {
                    showAlert('Error saving configuration: ' + error.message, 'error');
                }
            }
        }

        // Collect WYSIWYG data for New Business Pipeline
        function getNewBizWYSIWYGData() {
            const stages = ['warmLeads', 'pitchesHappening', 'pitchSubmitted', 'pitchPresented', 'pitchWon'];
            const pipelineData = {};
            
            stages.forEach(stage => {
                pipelineData[stage] = [];
                const container = document.getElementById(`${stage}Items`);
                if (container) {
                    Array.from(container.children).forEach(item => {
                        const inputs = item.querySelectorAll('input, select');
                        if (inputs.length >= 5) {
                            pipelineData[stage].push({
                                name: inputs[0].value || '',
                                office: inputs[1].value || '',
                                dueDate: inputs[2].value || '',
                                deckLink: inputs[3].value || '',
                                briefLink: inputs[4].value || ''
                            });
                        }
                    });
                }
            });

            return {
                header: "RALPH PIPELINE TRACKER 1.0",
                ...pipelineData
            };
        }

        // Collect WYSIWYG data for Premieres Calendar
        function getPremieresWYSIWYGData() {
            const thisMonth = [];
            const thisMonthContainer = document.getElementById('thisMonth');
            if (thisMonthContainer) {
                Array.from(thisMonthContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 3) {
                        thisMonth.push({
                            date: inputs[0].value,
                            project: inputs[1].value,
                            liveLink: inputs[2].value
                        });
                    }
                });
            }

            const nextMonth = [];
            const nextMonthContainer = document.getElementById('nextMonth');
            if (nextMonthContainer) {
                Array.from(nextMonthContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 3) {
                        nextMonth.push({
                            date: inputs[0].value,
                            project: inputs[1].value,
                            liveLink: inputs[2].value
                        });
                    }
                });
            }

            return {
                thisMonth,
                nextMonth
            };
        }

        // Collect WYSIWYG data for Shoutouts
        function getShoutoutsWYSIWYGData() {
            const birthdays = [];
            const birthdaysContainer = document.getElementById('birthdays');
            if (birthdaysContainer) {
                Array.from(birthdaysContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 3) {
                        birthdays.push({
                            date: inputs[0].value,
                            person: inputs[1].value,
                            highlight: inputs[2].checked
                        });
                    }
                });
            }

            const anniversaries = [];
            const anniversariesContainer = document.getElementById('anniversaries');
            if (anniversariesContainer) {
                Array.from(anniversariesContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        anniversaries.push({
                            years: parseInt(inputs[0].value) || 1,
                            person: inputs[1].value
                        });
                    }
                });
            }

            const shoutouts = [];
            const shoutoutsContainer = document.getElementById('shoutouts');
            if (shoutoutsContainer) {
                Array.from(shoutoutsContainer.children).forEach(item => {
                    const textarea = item.querySelector('textarea');
                    const input = item.querySelector('input[type="text"]');
                    if (textarea && input) {
                        shoutouts.push({
                            message: textarea.value,
                            from: input.value
                        });
                    }
                });
            }

            return {
                birthdays,
                anniversaries,
                shoutouts
            };
        }

        // Collect WYSIWYG data for Creative Challenge
        function getChallengeWYSIWYGData() {
            function getChallengeData(type) {
                return {
                    label: document.getElementById(`${type}Label`)?.value || '',
                    title: document.getElementById(`${type}Title`)?.value || '',
                    objective: document.getElementById(`${type}Objective`)?.value || '',
                    tone: document.getElementById(`${type}Tone`)?.value || '',
                    examples: document.getElementById(`${type}Examples`)?.value || '',
                    deliverables: document.getElementById(`${type}Deliverables`)?.value || '',
                    deadline: document.getElementById(`${type}Deadline`)?.value || ''
                };
            }

            return {
                creative: getChallengeData('creative'),
                social: getChallengeData('social'),
                newBusiness: getChallengeData('newBusiness')
            };
        }

        // Collect WYSIWYG data for Articles
        function getArticlesWYSIWYGData() {
            const trending = [];
            const trendingContainer = document.getElementById('trendingArticles');
            if (trendingContainer) {
                Array.from(trendingContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 1 && inputs[0].value.trim()) {
                        const articleData = {
                            title: inputs[0].value,
                            url: inputs.length >= 2 ? inputs[1].value : ''
                        };
                        trending.push(articleData);
                    }
                });
            }

            const mustReads = [];
            const mustReadsContainer = document.getElementById('mustReads');
            if (mustReadsContainer) {
                Array.from(mustReadsContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        mustReads.push({
                            source: inputs[0].value,
                            title: inputs[1].value,
                            url: inputs.length >= 3 ? inputs[2].value : ''
                        });
                    }
                });
            }

            return { trending, mustReads };
        }

        // Collect WYSIWYG data for RALPH News
        function getRalphNewsWYSIWYGData() {
            const breaking = [];
            const breakingContainer = document.getElementById('breakingNews');
            if (breakingContainer) {
                Array.from(breakingContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        breaking.push({
                            headline: inputs[0].value,
                            live: inputs[1].checked
                        });
                    }
                });
            }

            const updates = [];
            const updatesContainer = document.getElementById('generalUpdates');
            if (updatesContainer) {
                Array.from(updatesContainer.children).forEach(item => {
                    const input = item.querySelector('input');
                    if (input && input.value.trim()) {
                        updates.push(input.value);
                    }
                });
            }

            return { breaking, updates };
        }

        // Collect WYSIWYG data for Announcements
        function getAnnouncementsWYSIWYGData() {
            const important = [];
            const importantContainer = document.getElementById('importantAnnouncements');
            if (importantContainer) {
                Array.from(importantContainer.children).forEach(item => {
                    const input = item.querySelector('input');
                    if (input && input.value.trim()) {
                        important.push(input.value);
                    }
                });
            }

            const general = [];
            const generalContainer = document.getElementById('generalAnnouncements');
            if (generalContainer) {
                Array.from(generalContainer.children).forEach(item => {
                    const input = item.querySelector('input');
                    if (input && input.value.trim()) {
                        general.push(input.value);
                    }
                });
            }

            return { important, general };
        }

        // Collect WYSIWYG data for Links
        function getLinksWYSIWYGData() {
            const internal = [];
            const internalContainer = document.getElementById('internalLinks');
            if (internalContainer) {
                Array.from(internalContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        internal.push({
                            name: inputs[0].value,
                            url: inputs[1].value
                        });
                    }
                });
            }

            const external = [];
            const externalContainer = document.getElementById('externalLinks');
            if (externalContainer) {
                Array.from(externalContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        external.push({
                            name: inputs[0].value,
                            url: inputs[1].value
                        });
                    }
                });
            }

            return { internal, external };
        }

        // Collect WYSIWYG data for Innovation
        function getInnovationWYSIWYGData() {
            const experiments = [];
            const experimentsContainer = document.getElementById('experiments');
            if (experimentsContainer) {
                Array.from(experimentsContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2) {
                        experiments.push({
                            name: inputs[0].value,
                            progress: parseInt(inputs[1].value) || 0,
                            url: inputs.length >= 3 ? inputs[2].value : ''
                        });
                    }
                });
            }

            return {
                experiments,
                nextSession: {
                    topic: document.getElementById('nextSessionTopic')?.value || '',
                    speaker: document.getElementById('nextSessionSpeaker')?.value || ''
                }
            };
        }

        // Collect WYSIWYG data for Resources
        function getResourcesWYSIWYGData() {
            const documents = [];
            const documentsContainer = document.getElementById('documents');
            if (documentsContainer) {
                Array.from(documentsContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 1 && inputs[0].value.trim()) {
                        documents.push({
                            name: inputs[0].value,
                            url: inputs.length >= 2 ? inputs[1].value : ''
                        });
                    }
                });
            }

            const templates = [];
            const templatesContainer = document.getElementById('templates');
            if (templatesContainer) {
                Array.from(templatesContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 1 && inputs[0].value.trim()) {
                        templates.push({
                            name: inputs[0].value,
                            url: inputs.length >= 2 ? inputs[1].value : ''
                        });
                    }
                });
            }

            const training = [];
            const trainingContainer = document.getElementById('training');
            if (trainingContainer) {
                Array.from(trainingContainer.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 1 && inputs[0].value.trim()) {
                        training.push({
                            name: inputs[0].value,
                            url: inputs.length >= 2 ? inputs[1].value : ''
                        });
                    }
                });
            }

            return { documents, templates, training };
        }

        // Collect WYSIWYG data for Music
        function getMusicWYSIWYGData() {
            console.log('üéµ ADMIN: Getting music WYSIWYG data...');
            const tracks = [];
            const tracksContainer = document.getElementById('musicTracks');
            console.log('üéµ ADMIN: Tracks container found:', !!tracksContainer);
            console.log('üéµ ADMIN: Container children count:', tracksContainer?.children.length || 0);
            
            if (tracksContainer) {
                Array.from(tracksContainer.children).forEach((item, index) => {
                    const inputs = item.querySelectorAll('input');
                    console.log(`üéµ ADMIN: Track ${index} inputs found:`, inputs.length);
                    if (inputs.length >= 4) {
                        const track = {
                            id: index + 1,
                            title: inputs[0].value || `Track ${index + 1}`,
                            artist: inputs[1].value || 'Unknown Artist',
                            file: inputs[3].value || '',
                            duration: inputs[2].value || '0:00',
                            uploadDate: new Date().toISOString().split('T')[0]
                        };
                        console.log(`üéµ ADMIN: Track ${index} data:`, track);
                        tracks.push(track);
                    }
                });
            }
            console.log('üéµ ADMIN: Final tracks array:', tracks);

            // Calculate total duration (rough estimate)
            let totalSeconds = 0;
            tracks.forEach(track => {
                const [mins, secs] = track.duration.split(':').map(n => parseInt(n) || 0);
                totalSeconds += mins * 60 + secs;
            });
            const totalMins = Math.floor(totalSeconds / 60);
            const remainingSecs = totalSeconds % 60;
            const totalDuration = `${totalMins}:${remainingSecs.toString().padStart(2, '0')}`;

            return {
                tracks,
                totalTracks: tracks.length,
                totalDuration
            };
        }

        // Collect WYSIWYG data for Suggestions
        function getSuggestionsWYSIWYGData() {
            const recentSuggestions = [];
            const suggestionsContainer = document.getElementById('recentSuggestions');
            if (suggestionsContainer) {
                Array.from(suggestionsContainer.children).forEach(item => {
                    const textarea = item.querySelector('textarea');
                    const select = item.querySelector('select');
                    if (textarea && select) {
                        recentSuggestions.push({
                            idea: textarea.value,
                            status: select.value
                        });
                    }
                });
            }

            return { recentSuggestions };
        }

        // Save all changes
        function saveChanges() {
            // Update config from form fields
            updateConfigFromFields();
            
            // Here you would typically send to a backend API
            // For now, we'll simulate saving
            console.log('Saving config:', currentConfig);
            
            // Update the raw editor
            document.getElementById('rawEditor').value = JSON.stringify(currentConfig, null, 2);
            
            showAlert('Configuration saved successfully!', 'success');
        }

        function updateConfigFromFields() {
            // Update system settings
            currentConfig.system = {
                ...currentConfig.system,
                companyName: document.getElementById('companyName').value,
                primaryColor: document.getElementById('primaryColor').value,
                bootMessages: document.getElementById('bootMessages').value.split('\n').filter(msg => msg.trim()),
                ralphWorldUrl: document.getElementById('ralphWorldUrl').value
            };

            // Update chatbot settings
            currentConfig.chatbot = {
                ...currentConfig.chatbot,
                title: document.getElementById('chatbotTitle').value,
                welcomeMessage: document.getElementById('welcomeMessage').value,
                helpText: document.getElementById('helpText').value,
                openai: {
                    ...currentConfig.chatbot.openai,
                    enabled: document.getElementById('chatbotToggle').checked,
                    model: document.getElementById('openaiModel').value
                    // API key and system prompt are now managed separately
                }
            };

            // Update API settings
            try {
                const headers = JSON.parse(document.getElementById('apiHeaders').value);
                currentConfig.api = {
                    ...currentConfig.api,
                    baseUrl: document.getElementById('apiBaseUrl').value,
                    refreshInterval: parseInt(document.getElementById('refreshInterval').value),
                    headers
                };
            } catch (e) {
                console.error('Invalid JSON in API headers');
            }
        }

        // Raw editor functions
        function updateFromRaw() {
            try {
                currentConfig = JSON.parse(document.getElementById('rawEditor').value);
                populateFields();
                showAlert('Configuration updated from JSON!', 'success');
            } catch (e) {
                showAlert('Invalid JSON format. Please check your syntax.', 'error');
            }
        }

        function formatJSON() {
            try {
                const formatted = JSON.stringify(JSON.parse(document.getElementById('rawEditor').value), null, 2);
                document.getElementById('rawEditor').value = formatted;
            } catch (e) {
                showAlert('Invalid JSON format. Cannot format.', 'error');
            }
        }

        function resetToDefault() {
            if (confirm('Are you sure you want to reset to default configuration? This will lose all your changes.')) {
                if (typeof CMS_CONFIG !== 'undefined') {
                    currentConfig = JSON.parse(JSON.stringify(CMS_CONFIG));
                    populateFields();
                    document.getElementById('rawEditor').value = JSON.stringify(currentConfig, null, 2);
                    showAlert('Configuration reset to default!', 'success');
                }
            }
        }

        // Prompt Management Functions
        async function savePrompt() {
            const prompt = document.getElementById('systemPrompt').value.trim();
            const author = document.getElementById('promptAuthor').value.trim() || 'Unknown';
            const comment = document.getElementById('promptComment').value.trim();
            
            if (!prompt) {
                showAlert('Prompt cannot be empty', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/save-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        author: author,
                        comment: comment
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Prompt saved successfully! Version: ${result.version}`, 'success');
                    document.getElementById('promptComment').value = '';
                    updatePromptStatus();
                    // Refresh the last updated timestamp
                    loadPromptLastUpdated();
                } else {
                    showAlert(result.message || 'Failed to save prompt', 'error');
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
                showAlert('Error saving prompt', 'error');
            }
        }
        
        async function showPromptHistory() {
            try {
                const response = await fetch('/api/prompt-history');
                const result = await response.json();
                
                if (result.success) {
                    displayPromptHistory(result.history);
                } else {
                    showAlert('Failed to load prompt history', 'error');
                }
            } catch (error) {
                console.error('Error loading prompt history:', error);
                showAlert('Error loading prompt history', 'error');
            }
        }
        
        function displayPromptHistory(history) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 8px;
                max-width: 800px;
                max-height: 600px;
                width: 90%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            `;
            
            const header = document.createElement('div');
            header.style.cssText = `
                padding: 20px;
                background: var(--ralph-pink);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
            `;
            header.innerHTML = `
                <h3 style="margin: 0;">System Prompt History</h3>
                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
            `;
            
            const body = document.createElement('div');
            body.style.cssText = `
                padding: 20px;
                overflow-y: auto;
                flex: 1;
            `;
            
            if (history.length === 0) {
                body.innerHTML = '<p>No prompt history available.</p>';
            } else {
                const historyHtml = history.reverse().map(entry => `
                    <div style="border: 1px solid #ddd; border-radius: 4px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong>Version ${entry.id}</strong>
                            <div style="font-size: 12px; color: #666;">
                                by ${entry.author} on ${new Date(entry.timestamp).toLocaleString()}
                            </div>
                        </div>
                        ${entry.comment ? `<div style="color: #666; font-style: italic; margin-bottom: 8px;">${entry.comment}</div>` : ''}
                        <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto;">
                            ${entry.prompt.replace(/\n/g, '<br>')}
                        </div>
                        <div style="margin-top: 8px;">
                            <button onclick="restorePrompt(${entry.id})" style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Restore</button>
                        </div>
                    </div>
                `).join('');
                body.innerHTML = historyHtml;
            }
            
            content.appendChild(header);
            content.appendChild(body);
            modal.appendChild(content);
            modal.className = 'modal';
            document.body.appendChild(modal);
        }
        
        async function restorePrompt(versionId) {
            const author = document.getElementById('promptAuthor').value.trim() || 'Unknown';
            
            if (!confirm(`Restore to version ${versionId}? This will create a new version with the restored content.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/restore-prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        versionId: versionId,
                        author: author
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`Prompt restored to version ${versionId}!`, 'success');
                    document.querySelector('.modal').remove();
                    loadCurrentPrompt();
                    // Refresh the last updated timestamp
                    setTimeout(() => loadPromptLastUpdated(), 500);
                } else {
                    showAlert(result.message || 'Failed to restore prompt', 'error');
                }
            } catch (error) {
                console.error('Error restoring prompt:', error);
                showAlert('Error restoring prompt', 'error');
            }
        }
        
        async function loadCurrentPrompt() {
            try {
                const response = await fetch('/api/get-prompt');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('systemPrompt').value = result.prompt;
                    updatePromptStatus();
                    
                    // Load and display last updated info
                    loadPromptLastUpdated();
                }
            } catch (error) {
                console.error('Error loading current prompt:', error);
            }
        }
        
        async function loadPromptLastUpdated() {
            try {
                const response = await fetch('/api/prompt-history');
                const result = await response.json();
                
                if (result.success && result.history && result.history.length > 0) {
                    // Get the most recent entry
                    const latestEntry = result.history[result.history.length - 1];
                    const date = new Date(latestEntry.timestamp);
                    
                    // Format date as "Mar 30 1pm EST" style
                    const options = {
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true,
                        timeZoneName: 'short'
                    };
                    
                    const formattedDate = date.toLocaleString('en-US', options);
                    const lastUpdatedEl = document.getElementById('promptLastUpdated');
                    
                    if (lastUpdatedEl) {
                        lastUpdatedEl.innerHTML = `‚ÑπÔ∏è Last updated: ${formattedDate} by ${latestEntry.author || 'Unknown'}`;
                    }
                } else {
                    const lastUpdatedEl = document.getElementById('promptLastUpdated');
                    if (lastUpdatedEl) {
                        lastUpdatedEl.innerHTML = `‚ÑπÔ∏è Using default system prompt`;
                    }
                }
            } catch (error) {
                console.error('Error loading prompt history:', error);
            }
        }
        
        function updatePromptStatus() {
            const statusDiv = document.getElementById('promptStatus');
            statusDiv.textContent = 'Prompt loaded from persistent storage. Changes are automatically versioned.';
            statusDiv.style.color = '#4CAF50';
            
            setTimeout(() => {
                statusDiv.style.color = '#666';
            }, 3000);
        }

        // Utility functions
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.main-panel');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Update chatbot content (welcome message and help text)
        function updateChatbotContent() {
            const welcomeMessage = document.getElementById('welcomeMessage').value.trim();
            const helpText = document.getElementById('helpText').value.trim();
            
            if (!welcomeMessage) {
                showModuleStatus('chatbot-content', 'Welcome message cannot be empty', 'error');
                return;
            }
            
            if (!helpText) {
                showModuleStatus('chatbot-content', 'Help text cannot be empty', 'error');
                return;
            }
            
            // Update the config
            currentConfig.chatbot = {
                ...currentConfig.chatbot,
                welcomeMessage: welcomeMessage,
                helpText: helpText
            };
            
            // Show immediate feedback
            showModuleStatus('chatbot-content', 'Saving...', 'success');
            
            // Save to server
            saveConfigToServer('chatbot-content');
        }
        
        // Update boot messages
        function updateBootMessages() {
            const bootMessagesText = document.getElementById('bootMessages').value.trim();
            
            if (!bootMessagesText) {
                showModuleStatus('boot', 'Boot messages cannot be empty', 'error');
                return;
            }
            
            // Split into array and filter empty lines
            const bootMessages = bootMessagesText.split('\n').filter(msg => msg.trim());
            
            if (bootMessages.length === 0) {
                showModuleStatus('boot', 'Please add at least one boot message', 'error');
                return;
            }
            
            // Update the config
            currentConfig.system = {
                ...currentConfig.system,
                bootMessages: bootMessages
            };
            
            // Show immediate feedback
            showModuleStatus('boot', 'Saving...', 'success');
            
            // Save to server
            saveConfigToServer('boot');
        }
        
        // Show local module status message
        function showModuleStatus(moduleId, message, type) {
            const statusEl = document.getElementById(`status-${moduleId}`);
            const buttonEl = document.getElementById(`updateBtn-${moduleId}`);
            
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `module-status ${type} show`;
                
                // Add success flash to button
                if (type === 'success' && buttonEl) {
                    buttonEl.classList.add('success-flash');
                    setTimeout(() => {
                        buttonEl.classList.remove('success-flash');
                    }, 600);
                }
                
                // Hide message after 4 seconds
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 4000);
            }
        }

        function previewSite() {
            window.open('/', '_blank');
        }

        // Check for session-based auto-login
        async function checkAutoLogin() {
            const pathSegments = window.location.pathname.split('/');
            const sessionId = pathSegments[2]; // /admin/sessionId
            
            if (sessionId) {
                try {
                    const response = await fetch(`/api/check-session/${sessionId}`);
                    const result = await response.json();
                    
                    if (result.valid) {
                        // Auto-login successful
                        await login();
                        return true;
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                }
            }
            return false;
        }

        // Drag and Drop Functionality
        function initializeDragAndDrop() {
            // Add event listeners to all draggable items
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedElement = null;
        let draggedFromContainer = null;

        function handleDragStart(e) {
            draggedElement = this;
            draggedFromContainer = this.parentNode;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedElement = null;
            draggedFromContainer = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement && this.classList.contains('draggable-item')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this && this.classList.contains('draggable-item')) {
                const container = this.parentNode;
                const allItems = Array.from(container.children);
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);

                if (draggedIndex < targetIndex) {
                    container.insertBefore(draggedElement, this.nextSibling);
                } else {
                    container.insertBefore(draggedElement, this);
                }

                // Update indices for remove buttons
                updateContainerIndices(container);
            }

            this.classList.remove('drag-over');
            return false;
        }

        function updateContainerIndices(container) {
            const containerId = container.id;
            
            switch (containerId) {
                case 'warmLeadsItems':
                    updatePipelineIndices('warmLeads');
                    break;
                case 'pitchesHappeningItems':
                    updatePipelineIndices('pitchesHappening');
                    break;
                case 'pitchSubmittedItems':
                    updatePipelineIndices('pitchSubmitted');
                    break;
                case 'pitchPresentedItems':
                    updatePipelineIndices('pitchPresented');
                    break;
                case 'pitchWonItems':
                    updatePipelineIndices('pitchWon');
                    break;
                case 'thisMonth':
                    updateThisMonthIndices();
                    break;
                case 'nextMonth':
                    updateNextMonthIndices();
                    break;
                case 'birthdays':
                    updateBirthdayIndices();
                    break;
                case 'anniversaries':
                    updateAnniversaryIndices();
                    break;
                case 'shoutouts':
                    updateShoutoutIndices();
                    break;
                case 'trendingArticles':
                    updateTrendingArticleIndices();
                    break;
                case 'mustReads':
                    updateMustReadIndices();
                    break;
                case 'breakingNews':
                    updateBreakingNewsIndices();
                    break;
                case 'generalUpdates':
                    updateGeneralUpdateIndices();
                    break;
                case 'importantAnnouncements':
                    updateImportantAnnouncementIndices();
                    break;
                case 'generalAnnouncements':
                    updateGeneralAnnouncementIndices();
                    break;
                case 'internalLinks':
                    updateInternalLinkIndices();
                    break;
                case 'externalLinks':
                    updateExternalLinkIndices();
                    break;
                case 'experiments':
                    updateExperimentIndices();
                    break;
                case 'documents':
                    updateDocumentIndices();
                    break;
                case 'templates':
                    updateTemplateIndices();
                    break;
                case 'training':
                    updateTrainingIndices();
                    break;
                case 'recentSuggestions':
                    updateSuggestionIndices();
                    break;
            }
        }

        // WYSIWYG Editor Functions for New Business Pipeline
        function addPipelineItem(stage) {
            const container = document.getElementById(`${stage}Items`);
            if (!container) return;
            
            const newIndex = container.children.length;
            const newItemHtml = `
                <div class="pipeline-item-editor" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid var(--ralph-pink);">
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <button onclick="removePipelineItem('${stage}', ${newIndex})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px;">‚úï</button>
                        <input type="text" placeholder="Client/Project Name" style="flex: 2; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                        <select style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                            <option value="">Office</option>
                            <option value="LON">LON</option>
                            <option value="NY">NY</option>
                            <option value="LA">LA</option>
                            <option value="TK">TK</option>
                        </select>
                        <input type="date" placeholder="Due Date" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="url" placeholder="Google Drive Deck Link" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 11px;">
                        <input type="url" placeholder="Google Drive Brief Link" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 11px;">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHtml);
            updatePipelineIndices(stage);
        }

        function removePipelineItem(stage, index) {
            const container = document.getElementById(`${stage}Items`);
            if (container && container.children[index]) {
                container.children[index].remove();
                updatePipelineIndices(stage);
            }
        }

        function updatePipelineIndices(stage) {
            const container = document.getElementById(`${stage}Items`);
            if (!container) return;
            
            Array.from(container.children).forEach((item, index) => {
                const removeBtn = item.querySelector('button');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removePipelineItem('${stage}', ${index})`);
                }
            });
        }


        // WYSIWYG Editor Functions for Premieres Calendar
        function addThisMonth() {
            const container = document.getElementById('thisMonth');
            const newIndex = container.children.length;
            const newItemHtml = `
                <div class="premiere-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                    <button onclick="removeThisMonth(${newIndex})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                    <input type="text" value="" placeholder="Date" style="width: 100px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    <input type="text" value="" placeholder="Project name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHtml);
            updateThisMonthIndices();
        }

        function removeThisMonth(index) {
            const container = document.getElementById('thisMonth');
            container.children[index].remove();
            updateThisMonthIndices();
        }

        function updateThisMonthIndices() {
            const container = document.getElementById('thisMonth');
            Array.from(container.children).forEach((item, index) => {
                const removeBtn = item.querySelector('button');
                removeBtn.setAttribute('onclick', `removeThisMonth(${index})`);
            });
        }

        function addNextMonth() {
            const container = document.getElementById('nextMonth');
            const newIndex = container.children.length;
            const newItemHtml = `
                <div class="premiere-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                    <button onclick="removeNextMonth(${newIndex})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                    <input type="text" value="" placeholder="Date" style="width: 100px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    <input type="text" value="" placeholder="Project name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHtml);
            updateNextMonthIndices();
        }

        function removeNextMonth(index) {
            const container = document.getElementById('nextMonth');
            container.children[index].remove();
            updateNextMonthIndices();
        }

        function updateNextMonthIndices() {
            const container = document.getElementById('nextMonth');
            Array.from(container.children).forEach((item, index) => {
                const removeBtn = item.querySelector('button');
                removeBtn.setAttribute('onclick', `removeNextMonth(${index})`);
            });
        }

        // WYSIWYG Editor Functions for Shoutouts
        function addBirthday() {
            const container = document.getElementById('birthdays');
            const newIndex = container.children.length;
            const newItemHtml = `
                <div class="birthday-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                    <button onclick="removeBirthday(${newIndex})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                    <input type="text" value="" placeholder="Date" style="width: 100px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    <input type="text" value="" placeholder="Person name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    <label style="display: flex; align-items: center; gap: 8px; color: #b0b0b0;">
                        <input type="checkbox">
                        Highlight
                    </label>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHtml);
            updateBirthdayIndices();
        }

        function removeBirthday(index) {
            const container = document.getElementById('birthdays');
            container.children[index].remove();
            updateBirthdayIndices();
        }

        function updateBirthdayIndices() {
            const container = document.getElementById('birthdays');
            Array.from(container.children).forEach((item, index) => {
                const removeBtn = item.querySelector('button');
                removeBtn.setAttribute('onclick', `removeBirthday(${index})`);
            });
        }

        function addAnniversary() {
            const container = document.getElementById('anniversaries');
            const newIndex = container.children.length;
            const newItemHtml = `
                <div class="anniversary-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; gap: 12px; align-items: center;">
                    <button onclick="removeAnniversary(${newIndex})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                    <input type="number" value="1" placeholder="Years" style="width: 80px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    <span style="color: #b0b0b0;">years</span>
                    <input type="text" value="" placeholder="Person name" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHtml);
            updateAnniversaryIndices();
        }

        function removeAnniversary(index) {
            const container = document.getElementById('anniversaries');
            container.children[index].remove();
            updateAnniversaryIndices();
        }

        function updateAnniversaryIndices() {
            const container = document.getElementById('anniversaries');
            Array.from(container.children).forEach((item, index) => {
                const removeBtn = item.querySelector('button');
                removeBtn.setAttribute('onclick', `removeAnniversary(${index})`);
            });
        }

        function addShoutout() {
            const container = document.getElementById('shoutouts');
            const newIndex = container.children.length;
            const newItemHtml = `
                <div class="shoutout-item" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                    <div style="display: flex; gap: 12px; align-items: flex-start; margin-bottom: 8px;">
                        <button onclick="removeShoutout(${newIndex})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                        <textarea placeholder="Shoutout message" style="flex: 1; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
                    </div>
                    <input type="text" value="" placeholder="From (person/department)" style="width: 200px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; margin-left: 44px;">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newItemHtml);
            updateShoutoutIndices();
        }

        function removeShoutout(index) {
            const container = document.getElementById('shoutouts');
            container.children[index].remove();
            updateShoutoutIndices();
        }

        function updateShoutoutIndices() {
            const container = document.getElementById('shoutouts');
            Array.from(container.children).forEach((item, index) => {
                const removeBtn = item.querySelector('button');
                removeBtn.setAttribute('onclick', `removeShoutout(${index})`);
            });
        }

        // Additional index update functions for drag-and-drop
        function updateTrendingArticleIndices() {
            const container = document.getElementById('trendingArticles');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeTrendingArticle(${index})`);
                });
            }
        }

        function updateMustReadIndices() {
            const container = document.getElementById('mustReads');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeMustRead(${index})`);
                });
            }
        }

        function updateBreakingNewsIndices() {
            const container = document.getElementById('breakingNews');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeBreakingNews(${index})`);
                });
            }
        }

        function updateGeneralUpdateIndices() {
            const container = document.getElementById('generalUpdates');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeGeneralUpdate(${index})`);
                });
            }
        }

        function updateImportantAnnouncementIndices() {
            const container = document.getElementById('importantAnnouncements');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeImportantAnnouncement(${index})`);
                });
            }
        }

        function updateGeneralAnnouncementIndices() {
            const container = document.getElementById('generalAnnouncements');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeGeneralAnnouncement(${index})`);
                });
            }
        }

        function updateInternalLinkIndices() {
            const container = document.getElementById('internalLinks');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeInternalLink(${index})`);
                });
            }
        }

        function updateExternalLinkIndices() {
            const container = document.getElementById('externalLinks');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeExternalLink(${index})`);
                });
            }
        }

        function updateExperimentIndices() {
            const container = document.getElementById('experiments');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeExperiment(${index})`);
                });
            }
        }

        // Weekly Share Challenge Editor
        function getSharingEditor(content) {
            const items = content.items || [];
            const weekOf = content.weekOf || '';
            const giftCardAmount = content.giftCardAmount || '$25';

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üì≤ Weekly Share Challenge Settings</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="color: #ccc; display: block; margin-bottom: 5px;">Week Of</label>
                            <input type="text" id="shareWeekOf" value="${weekOf}" placeholder="August 20, 2024" 
                                   style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: #ccc; display: block; margin-bottom: 5px;">Gift Card Amount</label>
                            <input type="text" id="shareGiftAmount" value="${giftCardAmount}" placeholder="$25" 
                                   style="width: 100%; background: #2d2d2d; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <h5 style="color: var(--ralph-pink); margin-bottom: 12px;">Share Items (${items.length}/3)</h5>
                    <div id="shareItemsEditor">
                        ${items.map((item, index) => `
                            <div class="share-item-editor" style="background: #2d2d2d; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #404040;">
                                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                                    <h6 style="color: var(--ralph-pink); margin: 0;">Item ${index + 1}</h6>
                                    <button onclick="removeShareItem(${index})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: auto;">Remove</button>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <label style="color: #ccc; font-size: 12px;">Type</label>
                                        <input type="text" value="${item.type || ''}" placeholder="Instagram Post" 
                                               style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 3px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="color: #ccc; font-size: 12px;">Platform</label>
                                        <select style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 3px; font-size: 12px;">
                                            <option value="Instagram" ${item.platform === 'Instagram' ? 'selected' : ''}>Instagram</option>
                                            <option value="TikTok" ${item.platform === 'TikTok' ? 'selected' : ''}>TikTok</option>
                                            <option value="LinkedIn" ${item.platform === 'LinkedIn' ? 'selected' : ''}>LinkedIn</option>
                                            <option value="Substack" ${item.platform === 'Substack' ? 'selected' : ''}>Substack</option>
                                            <option value="YouTube" ${item.platform === 'YouTube' ? 'selected' : ''}>YouTube</option>
                                            <option value="Twitter" ${item.platform === 'Twitter' ? 'selected' : ''}>Twitter</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label style="color: #ccc; font-size: 12px;">Title</label>
                                    <input type="text" value="${item.title || ''}" placeholder="Behind the Scenes at RALPH Studio" 
                                           style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 3px; font-size: 12px;">
                                </div>
                                
                                <div style="margin-bottom: 10px;">
                                    <label style="color: #ccc; font-size: 12px;">Description</label>
                                    <textarea placeholder="Check out our creative process in action!" 
                                              style="width: 100%; height: 50px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 3px; font-size: 12px; resize: vertical;">${item.description || ''}</textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="color: #ccc; font-size: 12px;">Thumbnail URL</label>
                                        <input type="url" value="${item.thumbnail || ''}" placeholder="https://via.placeholder.com/300x200" 
                                               style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 3px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label style="color: #ccc; font-size: 12px;">Share URL</label>
                                        <input type="url" value="${item.shareUrl || ''}" placeholder="https://instagram.com/p/example" 
                                               style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 3px; font-size: 12px;">
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${items.length < 3 ? `
                        <button onclick="addShareItem()" class="btn btn-secondary" style="margin-top: 10px;">+ Add Share Item</button>
                    ` : `
                        <p style="color: #888; font-size: 12px; margin-top: 10px;">Maximum of 3 items reached</p>
                    `}
                </div>
            `;
        }

        // Music Library Editor
        function getMusicEditor(content) {
            const tracks = content.tracks || [];

            return `
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin: 16px 0;">
                    <h4 style="color: var(--ralph-pink); margin-bottom: 16px;">üéµ Music Library</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div style="background: #2d2d2d; padding: 12px; border-radius: 6px;">
                            <strong style="color: var(--ralph-pink);">Total Tracks:</strong> 
                            <span style="color: white;">${tracks.length}</span>
                        </div>
                        <div style="background: #2d2d2d; padding: 12px; border-radius: 6px;">
                            <strong style="color: var(--ralph-pink);">Total Duration:</strong> 
                            <span style="color: white;">${content.totalDuration || 'Unknown'}</span>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--ralph-pink); margin: 24px 0 16px;">üéß Track List</h4>
                    <div id="musicTracks">
                        ${tracks.map((track, index) => `
                            <div class="track-item draggable-item" draggable="true" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                                <div style="display: grid; grid-template-columns: auto auto 1fr 1fr auto auto; gap: 12px; align-items: center; margin-bottom: 8px;">
                                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                                    <button onclick="removeTrack(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                                    <input type="text" value="${track.title}" placeholder="Track Title" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <input type="text" value="${track.artist}" placeholder="Artist Name" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <input type="text" value="${track.duration}" placeholder="Duration" style="width: 80px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                    <button onclick="playPreview('${track.file}')" style="background: var(--ralph-pink); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚ñ∂</button>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; margin-left: 44px;">
                                    <input type="text" value="${track.file}" placeholder="File Path (music/filename.mp3)" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px; font-family: monospace;">
                                    <span style="color: #b0b0b0; font-size: 12px; padding: 6px;">Uploaded: ${track.uploadDate || 'Unknown'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addTrack()" class="btn btn-secondary" style="margin-top: 8px;">+ Add Track</button>
                    
                    <div style="background: #2d2d2d; padding: 12px; border-radius: 6px; margin-top: 16px;">
                        <h5 style="color: var(--ralph-pink); margin-bottom: 8px;">üìÅ File Management</h5>
                        <p style="color: #b0b0b0; font-size: 14px; margin-bottom: 8px;">Upload MP3 files to the /music/ directory on your server, then add them to the library above.</p>
                        <p style="color: #b0b0b0; font-size: 12px;">Supported formats: MP3. Recommended: 128-320 kbps, 44.1kHz</p>
                    </div>
                </div>
            `;
        }

        // Music management functions
        function addTrack() {
            const container = document.getElementById('musicTracks');
            if (container) {
                const index = container.children.length;
                const trackHtml = `
                    <div class="track-item draggable-item" draggable="true" style="background: #2d2d2d; padding: 12px; margin-bottom: 8px; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: auto auto 1fr 1fr auto auto; gap: 12px; align-items: center; margin-bottom: 8px;">
                            <span class="drag-handle">‚ãÆ‚ãÆ</span>
                            <button onclick="removeTrack(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚úï</button>
                            <input type="text" value="" placeholder="Track Title" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            <input type="text" value="" placeholder="Artist Name" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            <input type="text" value="" placeholder="Duration" style="width: 80px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                            <button onclick="playPreview('')" style="background: var(--ralph-pink); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer;">‚ñ∂</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; margin-left: 44px;">
                            <input type="text" value="" placeholder="File Path (music/filename.mp3)" style="background: #1e1e1e; border: 1px solid #404040; color: white; padding: 6px; border-radius: 4px; font-size: 12px; font-family: monospace;">
                            <span style="color: #b0b0b0; font-size: 12px; padding: 6px;">Uploaded: ${new Date().toISOString().split('T')[0]}</span>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', trackHtml);
                updateTrackIndices();
            }
        }

        function removeTrack(index) {
            const container = document.getElementById('musicTracks');
            if (container && container.children[index]) {
                container.children[index].remove();
                updateTrackIndices();
            }
        }

        function playPreview(filePath) {
            if (filePath) {
                const audio = new Audio(filePath);
                audio.volume = 0.5;
                audio.play().catch(e => console.log('Preview failed:', e));
            } else {
                alert('No file path specified');
            }
        }

        function updateTrackIndices() {
            const container = document.getElementById('musicTracks');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeTrack(${index})`);
                });
            }
        }

        function updateDocumentIndices() {
            const container = document.getElementById('documents');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeDocument(${index})`);
                });
            }
        }

        function updateTemplateIndices() {
            const container = document.getElementById('templates');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeTemplate(${index})`);
                });
            }
        }

        function updateTrainingIndices() {
            const container = document.getElementById('training');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeTraining(${index})`);
                });
            }
        }

        function updateSuggestionIndices() {
            const container = document.getElementById('recentSuggestions');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeSuggestion(${index})`);
                });
            }
        }

        // Sharing Module Helper Functions
        function addShareItem() {
            const container = document.getElementById('shareItemsEditor');
            if (!container) return;

            const items = Array.from(container.querySelectorAll('.share-item-editor'));
            if (items.length >= 3) {
                showNotification('Maximum of 3 items allowed', 'error');
                return;
            }

            const index = items.length;
            const newItemHTML = `
                <div class="share-item-editor" style="background: #2d2d2d; padding: 16px; border-radius: 6px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 12px;">
                        <h6 style="color: var(--ralph-pink); margin: 0;">Share Item ${index + 1}</h6>
                        <button onclick="removeShareItem(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <label style="color: #ccc; display: block; margin-bottom: 4px; font-size: 12px;">Content Type</label>
                            <select style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                                <option value="Instagram Post">Instagram Post</option>
                                <option value="TikTok Video">TikTok Video</option>
                                <option value="Substack Article">Substack Article</option>
                                <option value="YouTube Video">YouTube Video</option>
                                <option value="LinkedIn Post">LinkedIn Post</option>
                                <option value="Twitter Post">Twitter Post</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #ccc; display: block; margin-bottom: 4px; font-size: 12px;">Platform</label>
                            <input type="text" placeholder="Instagram" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #ccc; display: block; margin-bottom: 4px; font-size: 12px;">Title</label>
                        <input type="text" placeholder="Enter share item title" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #ccc; display: block; margin-bottom: 4px; font-size: 12px;">Description</label>
                        <textarea placeholder="Brief description of the content..." style="width: 100%; height: 60px; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="color: #ccc; display: block; margin-bottom: 4px; font-size: 12px;">Thumbnail URL</label>
                            <input type="text" placeholder="https://example.com/image.jpg" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="color: #ccc; display: block; margin-bottom: 4px; font-size: 12px;">Share URL</label>
                            <input type="text" placeholder="https://example.com/post" style="width: 100%; background: #1e1e1e; border: 1px solid #404040; color: white; padding: 8px; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', newItemHTML);
            updateShareItemIndices();
            
            // Update add button visibility
            const addButton = document.querySelector('button[onclick="addShareItem()"]');
            if (items.length + 1 >= 3 && addButton) {
                addButton.style.display = 'none';
            }
        }

        function removeShareItem(index) {
            const container = document.getElementById('shareItemsEditor');
            if (!container) return;

            const items = Array.from(container.querySelectorAll('.share-item-editor'));
            if (index >= 0 && index < items.length) {
                items[index].remove();
                updateShareItemIndices();
                
                // Show add button if we're under limit
                const addButton = document.querySelector('button[onclick="addShareItem()"]');
                if (container.children.length < 3 && addButton) {
                    addButton.style.display = 'inline-block';
                }
            }
        }

        function updateShareItemIndices() {
            const container = document.getElementById('shareItemsEditor');
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const removeBtn = item.querySelector('button[onclick^="removeShareItem"]');
                    if (removeBtn) removeBtn.setAttribute('onclick', `removeShareItem(${index})`);
                    
                    const title = item.querySelector('h6');
                    if (title) title.textContent = `Share Item ${index + 1}`;
                });
            }
        }

        function getSharingWYSIWYGData() {
            const weekOf = document.getElementById('shareWeekOf')?.value || '';
            const giftCardAmount = document.getElementById('shareGiftAmount')?.value || '$25';
            
            const container = document.getElementById('shareItemsEditor');
            const items = [];
            
            if (container) {
                Array.from(container.children).forEach((item, index) => {
                    const inputs = item.querySelectorAll('input, select, textarea');
                    const typeSelect = inputs[0];
                    const platformInput = inputs[1];
                    const titleInput = inputs[2];
                    const descTextarea = inputs[3];
                    const thumbnailInput = inputs[4];
                    const shareUrlInput = inputs[5];
                    
                    if (titleInput?.value.trim()) {
                        items.push({
                            id: index + 1,
                            type: typeSelect?.value || 'Instagram Post',
                            platform: platformInput?.value || 'Instagram',
                            title: titleInput.value.trim(),
                            description: descTextarea?.value || '',
                            thumbnail: thumbnailInput?.value || `https://via.placeholder.com/300x200/EB008B/FFFFFF?text=${encodeURIComponent(titleInput.value.slice(0, 20))}`,
                            shareUrl: shareUrlInput?.value || '#'
                        });
                    }
                });
            }
            
            return {
                weekOf,
                giftCardAmount,
                items
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Try auto-login first
            const autoLoggedIn = await checkAutoLogin();
            
            // Load prompt if auto-logged in
            if (autoLoggedIn && isLoggedIn) {
                setTimeout(() => {
                    loadCurrentPrompt(); // Load current prompt from persistent storage
                }, 100);
            }
        });
    </script>
</body>
</html>